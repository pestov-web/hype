# Architecture Evolution - Visual Roadmap

## Phase 0: Current State (P2P Mesh)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CURRENT: P2P Mesh (2-8 users)                              â”‚
â”‚                                                              â”‚
â”‚    User A â†â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ User B                                â”‚
â”‚      â†–                  â†—                                    â”‚
â”‚        â†–              â†—                                      â”‚
â”‚          User C â†â”€â”€â”€                                         â”‚
â”‚                                                              â”‚
â”‚  âœ… Advantages:                                              â”‚
â”‚  â€¢ Low latency (~50ms)                                       â”‚
â”‚  â€¢ No server costs                                           â”‚
â”‚  â€¢ No single point of failure                                â”‚
â”‚  â€¢ Privacy (end-to-end)                                      â”‚
â”‚                                                              â”‚
â”‚  âŒ Disadvantages:                                           â”‚
â”‚  â€¢ N*(N-1)/2 connections (doesn't scale)                     â”‚
â”‚  â€¢ High client bandwidth (N-1 uploads)                       â”‚
â”‚  â€¢ CPU intensive for large groups                            â”‚
â”‚                                                              â”‚
â”‚  ğŸ“Š Limits:                                                  â”‚
â”‚  â€¢ Optimal: 2-4 users                                        â”‚
â”‚  â€¢ Acceptable: 5-8 users                                     â”‚
â”‚  â€¢ Critical: 9-10 users (too many connections)               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 1: Hybrid P2P + SFU (Target: 3 weeks)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 1: Hybrid Architecture                               â”‚
â”‚                                                              â”‚
â”‚  Small Groups (2-8 users):                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  User A â†â”€â”€â”€â”€â”€â†’ User B               â”‚                   â”‚
â”‚  â”‚    â†–            â†—                    â”‚  P2P Mode         â”‚
â”‚  â”‚      â†–        â†—                      â”‚  (Direct)         â”‚
â”‚  â”‚        User C                        â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                              â”‚
â”‚  Large Groups (9+ users):                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚  â”‚  User A â”€â”€â”                          â”‚                   â”‚
â”‚  â”‚  User B â”€â”€â”¤                          â”‚                   â”‚
â”‚  â”‚  User C â”€â”€â”¼â”€â”€â†’ [SFU Server] â”€â”€â”¬â”€â”€â†’ User D  â”‚  SFU Mode  â”‚
â”‚  â”‚  User E â”€â”€â”¤                    â””â”€â”€â†’ User F  â”‚  (Routed)  â”‚
â”‚  â”‚  User G â”€â”€â”˜                          â”‚                   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚
â”‚                                                              â”‚
â”‚  ğŸ”„ Auto-switching:                                          â”‚
â”‚  if (participantCount <= 8) â†’ P2P                            â”‚
â”‚  if (participantCount >= 9) â†’ SFU                            â”‚
â”‚                                                              â”‚
â”‚  ğŸ’° Cost: ~$50-100/month (1 VPS server)                      â”‚
â”‚  ğŸ‘¥ Capacity: 10-50 concurrent voice users                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 2: Multi-Region SFU (Target: 3 months)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 2: Multi-Region SFU Cluster                          â”‚
â”‚                                                              â”‚
â”‚             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚             â”‚ Load Balancer   â”‚                              â”‚
â”‚             â”‚  (Cloudflare)   â”‚                              â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                      â”‚                                       â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚       â”‚              â”‚              â”‚                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ SFU US  â”‚    â”‚ SFU EU â”‚    â”‚ SFU AP â”‚                    â”‚
â”‚  â”‚ East    â”‚    â”‚ West   â”‚    â”‚ South  â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                    â”‚
â”‚       â”‚             â”‚             â”‚                          â”‚
â”‚       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                     â”‚                                        â”‚
â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”‚
â”‚            â”‚  Redis Cluster   â”‚                              â”‚
â”‚            â”‚  (coordination)  â”‚                              â”‚
â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                                                              â”‚
â”‚  ğŸŒ Routing:                                                 â”‚
â”‚  â€¢ User location â†’ Nearest SFU                               â”‚
â”‚  â€¢ Channel â†’ Sticky to one SFU node                          â”‚
â”‚  â€¢ Auto-failover if SFU dies                                 â”‚
â”‚                                                              â”‚
â”‚  ğŸ’° Cost: ~$300-500/month (3 SFU nodes + Redis)              â”‚
â”‚  ğŸ‘¥ Capacity: 100-200 concurrent voice users                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 3: Microservices (Target: 6 months)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 3: Microservices Architecture                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚          API Gateway (Kong/Nginx)                    â”‚   â”‚
â”‚  â”‚     Rate limiting, Auth, Routing                     â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                     â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚           â”‚           â”‚                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â–¼â”€â”€â”€â”€â”€â”                       â”‚
â”‚    â”‚ Auth   â”‚  â”‚Channel â”‚  â”‚ Voice  â”‚                       â”‚
â”‚    â”‚Service â”‚  â”‚Service â”‚  â”‚Service â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”˜  â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜  â””â”€â”€â”¬â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚         â”‚          â”‚          â”‚                              â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â”‚
â”‚                    â”‚                                         â”‚
â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚       â”‚            â”‚            â”‚                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚Postgresâ”‚  â”‚  Redis  â”‚  â”‚ Kafka  â”‚                        â”‚
â”‚  â”‚(Shards)â”‚  â”‚ (Cache) â”‚  â”‚(Events)â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                              â”‚
â”‚  ğŸ”§ Features:                                                â”‚
â”‚  â€¢ Independent scaling per service                           â”‚
â”‚  â€¢ Database sharding by guild_id                             â”‚
â”‚  â€¢ Event-driven communication (Kafka)                        â”‚
â”‚  â€¢ Health checks + auto-recovery                             â”‚
â”‚                                                              â”‚
â”‚  ğŸ’° Cost: ~$1,500-3,000/month                                â”‚
â”‚  ğŸ‘¥ Capacity: 1,000-2,000 concurrent voice users             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Phase 4: Massive Scale (Target: 1 year)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PHASE 4: Discord-Level Scale                               â”‚
â”‚                                                              â”‚
â”‚  LARGE VOICE CHANNEL (100+ participants):                    â”‚
â”‚                                                              â”‚
â”‚         Speakers (active talkers)                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚User A â”‚User B â”‚User C â”‚                            â”‚
â”‚         â””â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”´â”€â”€â”€â”¬â”€â”€â”€â”˜                            â”‚
â”‚             â”‚       â”‚       â”‚                                â”‚
â”‚             â””â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”˜                                â”‚
â”‚                     â”‚                                        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”                                 â”‚
â”‚              â”‚  Core SFU   â”‚                                 â”‚
â”‚              â”‚(Aggregator) â”‚                                 â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                                 â”‚
â”‚                     â”‚                                        â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                            â”‚
â”‚         â”‚           â”‚           â”‚                            â”‚
â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â” â”Œâ”€â”€â”€â–¼â”€â”€â”€â”€â”                        â”‚
â”‚    â”‚SFU Edge1â”‚ â”‚SFU Edge2â”‚ â”‚SFU Edge3â”‚                       â”‚
â”‚    â”‚(25 users)â”‚(25 users)â”‚(25 users)â”‚                       â”‚
â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚          â”‚          â”‚                              â”‚
â”‚    Listeners  Listeners  Listeners                           â”‚
â”‚                                                              â”‚
â”‚  GAME STREAMING (1000+ viewers):                             â”‚
â”‚                                                              â”‚
â”‚    Streamer â†’ RTMP â†’ Transcode â†’ CDN â†’ HLS â†’ Viewers        â”‚
â”‚                                                              â”‚
â”‚  ğŸ“Š Features:                                                â”‚
â”‚  â€¢ Cascade SFU (Core â†’ Edge)                                 â”‚
â”‚  â€¢ CDN for mass broadcasting                                 â”‚
â”‚  â€¢ Adaptive bitrate streaming                                â”‚
â”‚  â€¢ Global distribution                                       â”‚
â”‚                                                              â”‚
â”‚  ğŸ’° Cost: ~$8,000-15,000/month                               â”‚
â”‚  ğŸ‘¥ Capacity: 10,000+ concurrent voice users                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Comparison Matrix

### Connection Count

| Users | P2P Connections | SFU Connections | Cascade SFU      |
| ----- | --------------- | --------------- | ---------------- |
| 3     | 3               | 3               | 3                |
| 5     | 10              | 5               | 5                |
| 8     | 28              | 8               | 8                |
| 10    | 45 âŒ           | 10 âœ…           | 10 âœ…            |
| 25    | 300 âŒâŒ        | 25 âœ…           | 25 âœ…            |
| 50    | 1,225 âŒâŒâŒ    | 50 âš ï¸           | 52 âœ… (2 edges)  |
| 100   | 4,950 âŒâŒâŒ    | 100 âŒ          | 104 âœ… (4 edges) |

### Bandwidth (per user)

| Architecture       | Upload (64 kbps/stream) | Download                       |
| ------------------ | ----------------------- | ------------------------------ |
| P2P (10 users)     | 576 kbps (9 streams) âŒ | 576 kbps                       |
| SFU (10 users)     | 64 kbps (1 stream) âœ…   | 576 kbps                       |
| SFU (50 users)     | 64 kbps âœ…              | 3,136 kbps âš ï¸                  |
| Cascade (50 users) | 64 kbps âœ…              | 1,280 kbps âœ… (only 20 active) |

### Latency

| Architecture | Typical Latency  | Notes                    |
| ------------ | ---------------- | ------------------------ |
| P2P          | 50-100ms âœ…      | Direct connection        |
| SFU          | 100-150ms âœ…     | One hop through server   |
| Cascade SFU  | 150-200ms âš ï¸     | Two hops (Core â†’ Edge)   |
| CDN (HLS)    | 2,000-5,000ms âŒ | High latency, mass scale |

---

## Decision Tree

```
Start: How many users in voice channel?

â”œâ”€ 2-8 users
â”‚  â””â”€â†’ Use P2P (Phase 0/1)
â”‚      âœ… Low latency
â”‚      âœ… No costs
â”‚      âœ… Best quality
â”‚
â”œâ”€ 9-25 users
â”‚  â””â”€â†’ Use Single SFU (Phase 1)
â”‚      âœ… Scalable
â”‚      âœ… Low costs ($50-100/m)
â”‚      âœ… Good latency
â”‚
â”œâ”€ 26-100 users
â”‚  â””â”€â†’ Use Multi-Region SFU (Phase 2)
â”‚      âœ… Global distribution
â”‚      âš ï¸ Medium costs ($300-500/m)
â”‚      âœ… Good latency
â”‚
â”œâ”€ 101-1,000 users
â”‚  â””â”€â†’ Use Cascade SFU (Phase 3/4)
â”‚      âœ… High scalability
â”‚      âš ï¸ High costs ($1,500-3,000/m)
â”‚      âš ï¸ Higher latency (150-200ms)
â”‚
â””â”€ 1,000+ viewers (game stream)
   â””â”€â†’ Use CDN (RTMP â†’ HLS) (Phase 4)
       âœ… Unlimited scale
       âš ï¸ Very high costs (transfer fees)
       âŒ High latency (2-5 seconds)
```

---

## Timeline & Costs Summary

| Phase       | Timeline | Users       | Monthly Cost   | Effort     |
| ----------- | -------- | ----------- | -------------- | ---------- |
| **Phase 0** | Now      | 10-20       | $0-50          | âœ… Done    |
| **Phase 1** | 3 weeks  | 50-100      | $50-100        | ğŸ”„ Next    |
| **Phase 2** | 3 months | 100-500     | $300-500       | ğŸ“‹ Planned |
| **Phase 3** | 6 months | 1,000-5,000 | $1,500-3,000   | ğŸ“‹ Planned |
| **Phase 4** | 1 year   | 10,000+     | $8,000-15,000+ | ğŸ“‹ Future  |

---

## Next Steps

**ğŸ¯ Start Here**: Read `docs/PHASE_1_HYBRID_MODE.md` for detailed 3-week implementation plan.

**Key Points**:

1. âœ… Current P2P architecture works great for small groups
2. âœ… Hybrid mode provides smooth scaling path
3. âœ… No code rewrites between phases
4. âœ… Pay only for what you need (start cheap, scale gradually)
5. âœ… Each phase builds on previous foundation

**Remember**: Discord took 5+ years to build this. You have a complete roadmap from day one! ğŸš€
